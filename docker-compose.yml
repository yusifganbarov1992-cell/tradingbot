version: '3.8'

services:
  # Trading Bot
  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: crypto-trading-bot
    restart: unless-stopped
    environment:
      # Binance API
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      
      # Telegram
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      
      # OpenAI (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Trading settings
      - AUTO_TRADE=${AUTO_TRADE:-false}
      - INITIAL_CAPITAL=${INITIAL_CAPITAL:-10000}
      - MAX_POSITIONS=${MAX_POSITIONS:-3}
      - RISK_PER_TRADE=${RISK_PER_TRADE:-0.02}
    volumes:
      - ./logs:/app/logs
      - ./models:/app/models
    networks:
      - trading-network
    healthcheck:
      test: ["CMD", "python", "-c", "import asyncio; from database_supabase import SupabaseClient; asyncio.run(SupabaseClient().test_connection())"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Dashboard
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: crypto-dashboard
    restart: unless-stopped
    ports:
      - "8501:8501"
    environment:
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      
      # Binance API (for live prices)
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    depends_on:
      - trading-bot
    volumes:
      - ./dashboard:/app/dashboard
      - ./modules:/app/modules
      - ./models:/app/models
    networks:
      - trading-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Watchdog (monitors bot health)
  watchdog:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: crypto-watchdog
    restart: unless-stopped
    command: python bot_watchdog.py
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    depends_on:
      - trading-bot
    volumes:
      - ./logs:/app/logs
    networks:
      - trading-network

networks:
  trading-network:
    driver: bridge

volumes:
  logs:
  models:
